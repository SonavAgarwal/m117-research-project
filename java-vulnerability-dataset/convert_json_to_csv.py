import json
import csv
import os

# File paths
json_file_path = "tool_assisted_manual_dataset.json"  # Update with your actual JSON file path
csv_file_path = "output.csv"

# Load JSON data from the file
with open(json_file_path, "r") as json_file:
    data = json.load(json_file)

# Convert JSON to CSV
with open(csv_file_path, "w", newline="") as csvfile:
    # Define CSV headers
    fieldnames = [
        "cve",
        "cwe",
        "repository",
        "fixing",
        "introducing",
        "intro_add",
        "intro_del",
        # "intro_stats",
        "fixing_stats",
        # "fixing_add",
        # "fixing_del",
        "days_between",
        "fixing_lines",
        "introducing_lines",
    ]

    writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
    writer.writeheader()

    for entry in data:
        # # Handle cases where `intro_stats` or `fixing_stats` might be 0 or missing
        if entry.get("intro_stats") == 0:
            introducing_stats = {"add": 0, "del": 0}
        else:
            introducing_stats = entry.get("intro_stats").get(entry["introducing"])
        # fixing_stats = entry.get("fixing_stats", {}).get(entry["fixing"][0], {"add": 0, "del": 0})

        # # Handle missing or empty `fixing_lines` and `introducing_lines`
        fixing_lines = entry.get("fixing_lines", {})
        introducing_lines = entry.get("introducing_lines", {})

        # Unpack JSON fields into a flat structure
        row = {
            "cve": entry["cve"],
            "cwe": entry["cwe"],
            "repository": entry["repository"],
            "fixing": ", ".join(entry["fixing"]),
            "introducing": entry["introducing"],
            "intro_add": introducing_stats["add"],
            "intro_del": introducing_stats["del"],
            # "fixing_add": fixing_stats["add"],
            # "fixing_del": fixing_stats["del"],
            # "intro_stats": str(entry.get("intro_stats")),
            "fixing_stats": str(entry.get("fixing_stats")),
            "days_between": entry["days_between"],
            "fixing_lines": ", ".join(
                f"{path}:{lines}"
                for path, lines in fixing_lines.items()
            ),
            "introducing_lines": ", ".join(
                f"{path}:{lines}"
                for path, lines in introducing_lines.items()
            ),
        }
        writer.writerow(row)

print(f"CSV file has been created: {os.path.abspath(csv_file_path)}")
