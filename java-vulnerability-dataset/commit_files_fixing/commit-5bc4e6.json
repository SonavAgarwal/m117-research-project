{
    "sha": "5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9",
    "node_id": "MDY6Q29tbWl0MjQ5MzkwNDo1YmM0ZTZkN2IxYzIyZGMxYmY5OWY0NzViN2U3MDU5NGViZGQ4M2I5",
    "commit": {
        "author": {
            "name": "Mark Thomas",
            "email": "markt@apache.org",
            "date": "2019-04-03T15:00:38Z"
        },
        "committer": {
            "name": "Mark Thomas",
            "email": "markt@apache.org",
            "date": "2019-04-10T10:22:20Z"
        },
        "message": "Limit CGI command line arguments\n\nLimit the decoded form of individual command line arguments. This is to\nwork various issues passing command line arguments from Java to the OS\non Windows.\nThis restriction may be overridden by the new initialisation parameter\ncmdLineArgumentsDecoded.\nThis is the fix for CVE-2019-0232.",
        "tree": {
            "sha": "3da55939d34a2ae48b8a7334493442d0be9825da",
            "url": "https://api.github.com/repos/apache/tomcat/git/trees/3da55939d34a2ae48b8a7334493442d0be9825da"
        },
        "url": "https://api.github.com/repos/apache/tomcat/git/commits/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9",
        "comment_count": 0,
        "verification": {
            "verified": false,
            "reason": "unsigned",
            "signature": null,
            "payload": null,
            "verified_at": null
        }
    },
    "url": "https://api.github.com/repos/apache/tomcat/commits/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9",
    "html_url": "https://github.com/apache/tomcat/commit/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9",
    "comments_url": "https://api.github.com/repos/apache/tomcat/commits/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/comments",
    "author": {
        "login": "markt-asf",
        "id": 4690029,
        "node_id": "MDQ6VXNlcjQ2OTAwMjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4690029?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/markt-asf",
        "html_url": "https://github.com/markt-asf",
        "followers_url": "https://api.github.com/users/markt-asf/followers",
        "following_url": "https://api.github.com/users/markt-asf/following{/other_user}",
        "gists_url": "https://api.github.com/users/markt-asf/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/markt-asf/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/markt-asf/subscriptions",
        "organizations_url": "https://api.github.com/users/markt-asf/orgs",
        "repos_url": "https://api.github.com/users/markt-asf/repos",
        "events_url": "https://api.github.com/users/markt-asf/events{/privacy}",
        "received_events_url": "https://api.github.com/users/markt-asf/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
    },
    "committer": {
        "login": "markt-asf",
        "id": 4690029,
        "node_id": "MDQ6VXNlcjQ2OTAwMjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4690029?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/markt-asf",
        "html_url": "https://github.com/markt-asf",
        "followers_url": "https://api.github.com/users/markt-asf/followers",
        "following_url": "https://api.github.com/users/markt-asf/following{/other_user}",
        "gists_url": "https://api.github.com/users/markt-asf/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/markt-asf/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/markt-asf/subscriptions",
        "organizations_url": "https://api.github.com/users/markt-asf/orgs",
        "repos_url": "https://api.github.com/users/markt-asf/repos",
        "events_url": "https://api.github.com/users/markt-asf/events{/privacy}",
        "received_events_url": "https://api.github.com/users/markt-asf/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
    },
    "parents": [
        {
            "sha": "1c1d49ed4e6ef6a9a08aa341d77e891c38f8637c",
            "url": "https://api.github.com/repos/apache/tomcat/commits/1c1d49ed4e6ef6a9a08aa341d77e891c38f8637c",
            "html_url": "https://github.com/apache/tomcat/commit/1c1d49ed4e6ef6a9a08aa341d77e891c38f8637c"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 80,
        "deletions": 2
    },
    "files": [
        {
            "sha": "0a348386a6a8920f3c8184234378e023bc647d6b",
            "filename": "conf/web.xml",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/apache/tomcat/blob/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/conf%2Fweb.xml",
            "raw_url": "https://github.com/apache/tomcat/raw/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/conf%2Fweb.xml",
            "contents_url": "https://api.github.com/repos/apache/tomcat/contents/conf%2Fweb.xml?ref=5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9",
            "patch": "@@ -335,6 +335,20 @@\n   <!--                        If not set, then webAppRootDir is used.       -->\n   <!--                        Recommended value: WEB-INF/cgi                -->\n   <!--                                                                      -->\n+  <!--  cmdLineArgumentsDecoded                                             -->\n+  <!--                        Only used when enableCmdLineArguments is      -->\n+  <!--                        true. The pattern that individual decoded     -->\n+  <!--                        command line arguments must match else the    -->\n+  <!--                        request will be rejected. This is to          -->\n+  <!--                        work-around various issues when Java passes   -->\n+  <!--                        the arguments to the OS. See the CGI How-To   -->\n+  <!--                        for more details. The default varies by       -->\n+  <!--                        platform.                                     -->\n+  <!--                        Windows: [[a-zA-Z0-9\\Q-_.\\\\/:\\E]+]            -->\n+  <!--                        Others:  [.*]                                 -->\n+  <!--                        Note that internally the CGI Servlet treats   -->\n+  <!--                        [.*] as a special case to improve performance -->\n+  <!--                                                                      -->\n   <!--   cmdLineArgumentsEncoded                                            -->\n   <!--                        Only used when enableCmdLineArguments is      -->\n   <!--                        true. The pattern that individual encoded     -->"
        },
        {
            "sha": "56d912ca906460b0e4b74e7932eb812e83e987de",
            "filename": "java/org/apache/catalina/servlets/CGIServlet.java",
            "status": "modified",
            "additions": 38,
            "deletions": 1,
            "changes": 39,
            "blob_url": "https://github.com/apache/tomcat/blob/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/java%2Forg%2Fapache%2Fcatalina%2Fservlets%2FCGIServlet.java",
            "raw_url": "https://github.com/apache/tomcat/raw/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/java%2Forg%2Fapache%2Fcatalina%2Fservlets%2FCGIServlet.java",
            "contents_url": "https://api.github.com/repos/apache/tomcat/contents/java%2Forg%2Fapache%2Fcatalina%2Fservlets%2FCGIServlet.java?ref=5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9",
            "patch": "@@ -52,6 +52,7 @@\n import org.apache.catalina.util.IOTools;\n import org.apache.juli.logging.Log;\n import org.apache.juli.logging.LogFactory;\n+import org.apache.tomcat.util.compat.JrePlatform;\n import org.apache.tomcat.util.res.StringManager;\n \n \n@@ -245,10 +246,21 @@ public final class CGIServlet extends HttpServlet {\n     private static final long serialVersionUID = 1L;\n \n     private static final Set<String> DEFAULT_SUPER_METHODS = new HashSet<>();\n+    private static final Pattern DEFAULT_CMD_LINE_ARGUMENTS_DECODED_PATTERN;\n+    private static final String ALLOW_ANY_PATTERN = \".*\";\n+\n     static {\n         DEFAULT_SUPER_METHODS.add(\"HEAD\");\n         DEFAULT_SUPER_METHODS.add(\"OPTIONS\");\n         DEFAULT_SUPER_METHODS.add(\"TRACE\");\n+\n+        if (JrePlatform.IS_WINDOWS) {\n+            DEFAULT_CMD_LINE_ARGUMENTS_DECODED_PATTERN = Pattern.compile(\"[a-zA-Z0-9\\\\Q-_.\\\\/:\\\\E]+\");\n+        } else {\n+            // No restrictions\n+            DEFAULT_CMD_LINE_ARGUMENTS_DECODED_PATTERN = null;\n+        }\n+\n     }\n \n \n@@ -314,6 +326,14 @@ public final class CGIServlet extends HttpServlet {\n     private Pattern cmdLineArgumentsEncodedPattern =\n             Pattern.compile(\"[a-zA-Z0-9\\\\Q%;/?:@&,$-_.!~*'()\\\\E]+\");\n \n+    /**\n+     * Limits the decoded form of individual command line arguments. Default\n+     * varies by platform.\n+     */\n+    private Pattern cmdLineArgumentsDecodedPattern = DEFAULT_CMD_LINE_ARGUMENTS_DECODED_PATTERN;\n+\n+\n+\n     /**\n      * Sets instance variables.\n      * <P>\n@@ -411,6 +431,14 @@ public void init(ServletConfig config) throws ServletException {\n             cmdLineArgumentsEncodedPattern =\n                     Pattern.compile(getServletConfig().getInitParameter(\"cmdLineArgumentsEncoded\"));\n         }\n+\n+        String value = getServletConfig().getInitParameter(\"cmdLineArgumentsDecoded\");\n+        if (ALLOW_ANY_PATTERN.equals(value)) {\n+            // Optimisation for case where anything is allowed\n+            cmdLineArgumentsDecodedPattern = null;\n+        } else if (value != null) {\n+            cmdLineArgumentsDecodedPattern = Pattern.compile(value);\n+        }\n     }\n \n \n@@ -792,7 +820,17 @@ protected boolean setupFromRequest(HttpServletRequest req)\n                             }\n                             return false;\n                         }\n+\n                         String decodedArgument = URLDecoder.decode(encodedArgument, parameterEncoding);\n+                        if (cmdLineArgumentsDecodedPattern != null &&\n+                                !cmdLineArgumentsDecodedPattern.matcher(decodedArgument).matches()) {\n+                            if (log.isDebugEnabled()) {\n+                                log.debug(sm.getString(\"cgiServlet.invalidArgumentDecoded\",\n+                                        decodedArgument, cmdLineArgumentsDecodedPattern.toString()));\n+                            }\n+                            return false;\n+                        }\n+\n                         cmdLineParameters.add(decodedArgument);\n                     }\n                 }\n@@ -1101,7 +1139,6 @@ protected boolean setCGIEnvironment(HttpServletRequest req) throws IOException {\n             this.env = envp;\n \n             return true;\n-\n         }\n \n         /**"
        },
        {
            "sha": "2edd6bfdad1403ce3e8f45655cd01efd46807045",
            "filename": "java/org/apache/catalina/servlets/LocalStrings.properties",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/apache/tomcat/blob/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/java%2Forg%2Fapache%2Fcatalina%2Fservlets%2FLocalStrings.properties",
            "raw_url": "https://github.com/apache/tomcat/raw/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/java%2Forg%2Fapache%2Fcatalina%2Fservlets%2FLocalStrings.properties",
            "contents_url": "https://api.github.com/repos/apache/tomcat/contents/java%2Forg%2Fapache%2Fcatalina%2Fservlets%2FLocalStrings.properties?ref=5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9",
            "patch": "@@ -23,6 +23,7 @@ cgiServlet.expandOk=Expanded script at path [{0}] to [{1}]\n cgiServlet.find.found=Found CGI: name [{0}], path [{1}], script name [{2}] and CGI name [{3}]\n cgiServlet.find.location=Looking for a file at [{0}]\n cgiServlet.find.path=CGI script requested at path [{0}] relative to CGI location [{1}]\n+cgiServlet.invalidArgumentDecoded=The decoded command line argument [{0}] did not match the configured cmdLineArgumentsDecoded pattern [{1}]\n cgiServlet.invalidArgumentEncoded=The encoded command line argument [{0}] did not match the configured cmdLineArgumentsEncoded pattern [{1}]\n cgiServlet.runBadHeader=Bad header line [{0}]\n cgiServlet.runFail=I/O problems processing CGI"
        },
        {
            "sha": "b368f3c54131847255cb5c8938ebc42fdfb5f09f",
            "filename": "webapps/docs/cgi-howto.xml",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/apache/tomcat/blob/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/webapps%2Fdocs%2Fcgi-howto.xml",
            "raw_url": "https://github.com/apache/tomcat/raw/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/webapps%2Fdocs%2Fcgi-howto.xml",
            "contents_url": "https://api.github.com/repos/apache/tomcat/contents/webapps%2Fdocs%2Fcgi-howto.xml?ref=5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9",
            "patch": "@@ -102,12 +102,22 @@ the web application root directory + File.separator + this prefix.\n By default there is no value, which results in the web application root\n directory being used as the search path. The recommended value is\n <code>WEB-INF/cgi</code></li>\n+<li><strong>cmdLineArgumentsDecoded</strong> - If command line argumemnts\n+are enabled (via <strong>enableCmdLineArguments</strong>) and Tomcat is running\n+on Windows then each individual decoded command line argument must match this\n+pattern else the request will be rejected. This is to protect against known\n+issues passing command line arguments from Java to Windows. These issues can\n+lead to remote code execution. For more information on these issues see\n+<a href=\"https://codewhitesec.blogspot.com/2016/02/java-and-command-line-injections-in-windows.html\">Markus\n+Wulftange&apos;s blog</a> and this archived\n+<a href=\"https://web.archive.org/web/20161228144344/https://blogs.msdn.microsoft.com/twistylittlepassagesallalike/2011/04/23/everyone-quotes-command-line-arguments-the-wrong-way/\">blog\n+by Daniel Colascione</a>.</li>\n <li><strong>cmdLineArgumentsEncoded</strong> - If command line argumemnts\n are enabled (via <strong>enableCmdLineArguments</strong>) individual encoded\n command line argument must match this pattern else the request will be rejected.\n The default matches the allowed values defined by RFC3875 and is\n <code>[a-zA-Z0-9\\Q%;/?:@&amp;,$-_.!~*'()\\E]+</code></li>\n-<li><strong>enableCmdLineArguments</strong> - Are command line parameters\n+<li><strong>enableCmdLineArguments</strong> - Are command line arguments\n generated from the query string as per section 4.4 of 3875 RFC? The default is\n <code>true</code>.</li>\n <li><strong>environment-variable-</strong> - An environment to be set for the"
        },
        {
            "sha": "79610111cf25c73a8f8ee5011101c868626b9522",
            "filename": "webapps/docs/changelog.xml",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/apache/tomcat/blob/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/webapps%2Fdocs%2Fchangelog.xml",
            "raw_url": "https://github.com/apache/tomcat/raw/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/webapps%2Fdocs%2Fchangelog.xml",
            "contents_url": "https://api.github.com/repos/apache/tomcat/contents/webapps%2Fdocs%2Fchangelog.xml?ref=5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9",
            "patch": "@@ -103,6 +103,14 @@\n         3875. This restriction may be relaxed by the use of the new\n         initialisation parameter <code>cmdLineArgumentsEncoded</code>. (markt)\n       </add>\n+      <add>\n+        When the CGI Servlet is configured with\n+        <code>enableCmdLineArguments</code> set to true, limit the decoded form\n+        of the individual command line arguments to known safe values when\n+        running on Windows. This restriction may be relaxed by the use of the\n+        new initialisation parameter <code>cmdLineArgumentsDecoded</code>. This\n+        is the fix for CVE-2019-0232. (markt)\n+      </add>\n     </changelog>\n   </subsection>\n   <subsection name=\"Coyote\">"
        },
        {
            "sha": "71358de4cd82afcdfcc0dc8405b2c6d984618c28",
            "filename": "webapps/docs/security-howto.xml",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/apache/tomcat/blob/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/webapps%2Fdocs%2Fsecurity-howto.xml",
            "raw_url": "https://github.com/apache/tomcat/raw/5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9/webapps%2Fdocs%2Fsecurity-howto.xml",
            "contents_url": "https://api.github.com/repos/apache/tomcat/contents/webapps%2Fdocs%2Fsecurity-howto.xml?ref=5bc4e6d7b1c22dc1bf99f475b7e70594ebdd83b9",
            "patch": "@@ -507,6 +507,14 @@\n     initialisation parameter should not be set to <code>10</code> or higher on a\n     production system because the debug page is not secure.</p>\n \n+    <p>When using the CGI Servlet on Windows with\n+    <code>enableCmdLineArguments</code> enabled, review the setting of\n+    <code>cmdLineArgumentsDecoded</code> carefully and ensure that it is\n+    appropriate for your environment. The default value is secure. Insecure\n+    configurations may expose the server to remote code execution. Further\n+    information on the potential risks and mitigations may be found by\n+    following the links in the <a href=\"cgi-howto.html\">CGI How To</a>.</p>\n+\n     <p><a href=\"config/filter.html\">FailedRequestFilter</a>\n     can be configured and used to reject requests that had errors during\n     request parameter parsing. Without the filter the default behaviour is"
        }
    ]
}