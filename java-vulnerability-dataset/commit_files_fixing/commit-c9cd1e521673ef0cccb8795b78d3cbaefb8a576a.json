{
    "sha": "c9cd1e521673ef0cccb8795b78d3cbaefb8a576a",
    "node_id": "MDY6Q29tbWl0MTg1MTE2ODc6YzljZDFlNTIxNjczZWYwY2NjYjg3OTViNzhkM2NiYWVmYjhhNTc2YQ==",
    "commit": {
        "author": {
            "name": "Gaston Dombiak",
            "email": "gaston@jivesoftware.com",
            "date": "2008-03-04T20:09:37Z"
        },
        "committer": {
            "name": "gato",
            "email": "gato@b35dd754-fafc-0310-a699-88a17e54d16e",
            "date": "2008-03-04T20:09:37Z"
        },
        "message": "Fixed DoS attack that could bring the server down. JM-1289\n\ngit-svn-id: http://svn.igniterealtime.org/svn/repos/openfire/branches/openfire_3_5_0@10031 b35dd754-fafc-0310-a699-88a17e54d16e",
        "tree": {
            "sha": "3a1d938a259b683167ed78adb0e595bc8fcbe53a",
            "url": "https://api.github.com/repos/igniterealtime/Openfire/git/trees/3a1d938a259b683167ed78adb0e595bc8fcbe53a"
        },
        "url": "https://api.github.com/repos/igniterealtime/Openfire/git/commits/c9cd1e521673ef0cccb8795b78d3cbaefb8a576a",
        "comment_count": 0,
        "verification": {
            "verified": false,
            "reason": "unsigned",
            "signature": null,
            "payload": null,
            "verified_at": null
        }
    },
    "url": "https://api.github.com/repos/igniterealtime/Openfire/commits/c9cd1e521673ef0cccb8795b78d3cbaefb8a576a",
    "html_url": "https://github.com/igniterealtime/Openfire/commit/c9cd1e521673ef0cccb8795b78d3cbaefb8a576a",
    "comments_url": "https://api.github.com/repos/igniterealtime/Openfire/commits/c9cd1e521673ef0cccb8795b78d3cbaefb8a576a/comments",
    "author": null,
    "committer": null,
    "parents": [
        {
            "sha": "9d4ff701f3e7871d0a1addb146fe7c8da1825a40",
            "url": "https://api.github.com/repos/igniterealtime/Openfire/commits/9d4ff701f3e7871d0a1addb146fe7c8da1825a40",
            "html_url": "https://github.com/igniterealtime/Openfire/commit/9d4ff701f3e7871d0a1addb146fe7c8da1825a40"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 58,
        "deletions": 3
    },
    "files": [
        {
            "sha": "9c6ebc956582f249d66a457747ab935c803d2d21",
            "filename": "documentation/dist/changelog.html",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/igniterealtime/Openfire/blob/c9cd1e521673ef0cccb8795b78d3cbaefb8a576a/documentation%2Fdist%2Fchangelog.html",
            "raw_url": "https://github.com/igniterealtime/Openfire/raw/c9cd1e521673ef0cccb8795b78d3cbaefb8a576a/documentation%2Fdist%2Fchangelog.html",
            "contents_url": "https://api.github.com/repos/igniterealtime/Openfire/contents/documentation%2Fdist%2Fchangelog.html?ref=c9cd1e521673ef0cccb8795b78d3cbaefb8a576a",
            "patch": "@@ -188,6 +188,7 @@ <h3>Openfire New Features</h3>\n \n <h3>Openfire Bug Fixes</h3>\n <ul>\n+<li>[<a href='http://www.igniterealtime.org/issues/browse/JM-1289'>JM-1289</a>] - <font color=\"red\"><b>!</b></font> Fixed DoS attack that could bring the server down.</li>\n <li>[<a href='http://www.igniterealtime.org/issues/browse/JM-1175'>JM-1175</a>] - Fixed double-byte characters problem. <b>(4 votes)</b></li>\n <li>[<a href='http://www.igniterealtime.org/issues/browse/JM-1274'>JM-1274</a>] - Fixed sending of presence packets when using direct presences.</li>\n <li>[<a href='http://www.igniterealtime.org/issues/browse/JM-1275'>JM-1275</a>] - Messages sent to bare JIDs were not considering directed presences.</li>"
        },
        {
            "sha": "197c0c1df094e297ffdbad572ad7b218134d5de8",
            "filename": "src/java/org/jivesoftware/openfire/net/StalledSessionsFilter.java",
            "status": "added",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/igniterealtime/Openfire/blob/c9cd1e521673ef0cccb8795b78d3cbaefb8a576a/src%2Fjava%2Forg%2Fjivesoftware%2Fopenfire%2Fnet%2FStalledSessionsFilter.java",
            "raw_url": "https://github.com/igniterealtime/Openfire/raw/c9cd1e521673ef0cccb8795b78d3cbaefb8a576a/src%2Fjava%2Forg%2Fjivesoftware%2Fopenfire%2Fnet%2FStalledSessionsFilter.java",
            "contents_url": "https://api.github.com/repos/igniterealtime/Openfire/contents/src%2Fjava%2Forg%2Fjivesoftware%2Fopenfire%2Fnet%2FStalledSessionsFilter.java?ref=c9cd1e521673ef0cccb8795b78d3cbaefb8a576a",
            "patch": "@@ -0,0 +1,50 @@\n+/**\r\n+ * $RCSfile: ConnectionManagerImpl.java,v $\r\n+ * $Revision: $\r\n+ * $Date: $\r\n+ *\r\n+ * Copyright (C) 2008 Jive Software. All rights reserved.\r\n+ *\r\n+ * This software is published under the terms of the GNU Public License (GPL),\r\n+ * a copy of which is included in this distribution.\r\n+ */\r\n+\r\n+package org.jivesoftware.openfire.net;\r\n+\r\n+import org.apache.mina.common.IoFilterAdapter;\r\n+import org.apache.mina.common.IoSession;\r\n+import org.jivesoftware.util.Log;\r\n+import org.jivesoftware.util.JiveGlobals;\r\n+\r\n+import java.io.IOException;\r\n+import java.util.Date;\r\n+\r\n+/**\r\n+ * MINA filter that will close sessions that are failing to read outgoing traffic\r\n+ * and whose outgoing queue is around 5MB. Use the system property <tt>session.stalled.cap</tt>\r\n+ * to set the max number of bytes allowed in the outgoing queue of a session before considering\r\n+ * it stalled.\r\n+ *\r\n+ * @author Gaston Dombiak\r\n+ */\r\n+public class StalledSessionsFilter extends IoFilterAdapter {\r\n+    private static final int bytesCap = JiveGlobals.getIntProperty(\"session.stalled.cap\", 5242880);\r\n+\r\n+    public void filterWrite(NextFilter nextFilter, IoSession session, WriteRequest writeRequest)\r\n+            throws Exception {\r\n+        // Get number of pending requests\r\n+        int pendingBytes = session.getScheduledWriteBytes();\r\n+        if (pendingBytes > bytesCap) {\r\n+            // Get last time we were able to send something to the connected client\r\n+            long writeTime = session.getLastWriteTime();\r\n+            int pendingRequests = session.getScheduledWriteRequests();\r\n+            Log.debug(\"About to kill session with pendingBytes: \" + pendingBytes + \" pendingWrites: \" +\r\n+                    pendingRequests + \" lastWrite: \" + new Date(writeTime) + \"session: \" + session);\r\n+            // Close the session and throw an exception\r\n+            session.close();\r\n+            throw new IOException(\"Closing session that seems to be stalled. Preventing OOM\");\r\n+        }\r\n+        // Call next filter (everything is fine)\r\n+        super.filterWrite(nextFilter, session, writeRequest);\r\n+    }\r\n+}\r"
        },
        {
            "sha": "67d2d00ced1a34820a495e31a041a8cc3902e417",
            "filename": "src/java/org/jivesoftware/openfire/spi/ConnectionManagerImpl.java",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/igniterealtime/Openfire/blob/c9cd1e521673ef0cccb8795b78d3cbaefb8a576a/src%2Fjava%2Forg%2Fjivesoftware%2Fopenfire%2Fspi%2FConnectionManagerImpl.java",
            "raw_url": "https://github.com/igniterealtime/Openfire/raw/c9cd1e521673ef0cccb8795b78d3cbaefb8a576a/src%2Fjava%2Forg%2Fjivesoftware%2Fopenfire%2Fspi%2FConnectionManagerImpl.java",
            "contents_url": "https://api.github.com/repos/igniterealtime/Openfire/contents/src%2Fjava%2Forg%2Fjivesoftware%2Fopenfire%2Fspi%2FConnectionManagerImpl.java?ref=c9cd1e521673ef0cccb8795b78d3cbaefb8a576a",
            "patch": "@@ -1,9 +1,9 @@\n /**\r\n  * $RCSfile: ConnectionManagerImpl.java,v $\r\n- * $Revision: 3159 $\r\n- * $Date: 2005-12-04 22:56:40 -0300 (Sun, 04 Dec 2005) $\r\n+ * $Revision: $\r\n+ * $Date: $\r\n  *\r\n- * Copyright (C) 2007 Jive Software. All rights reserved.\r\n+ * Copyright (C) 2008 Jive Software. All rights reserved.\r\n  *\r\n  * This software is published under the terms of the GNU Public License (GPL),\r\n  * a copy of which is included in this distribution.\r\n@@ -324,6 +324,8 @@ private void createClientListeners() {\n             socketAcceptor.getDefaultConfig().setThreadModel(threadModel);\r\n             // Add the XMPP codec filter\r\n             socketAcceptor.getFilterChain().addFirst(\"xmpp\", new ProtocolCodecFilter(new XMPPCodecFactory()));\r\n+            // Kill sessions whose outgoing queues keep growing and fail to send traffic\r\n+            socketAcceptor.getFilterChain().addAfter(\"xmpp\", \"outCap\", new StalledSessionsFilter());\r\n         }\r\n     }\r\n \r\n@@ -408,6 +410,8 @@ public Thread newThread( Runnable runnable )\n                 // Add the XMPP codec filter\r\n                 sslSocketAcceptor.getFilterChain().addFirst(\"xmpp\", new ProtocolCodecFilter(new XMPPCodecFactory()));\r\n                 sslSocketAcceptor.getFilterChain().addFirst(\"threadModel\", executorFilter);\r\n+                // Kill sessions whose outgoing queues keep growing and fail to send traffic\r\n+                sslSocketAcceptor.getFilterChain().addAfter(\"xmpp\", \"outCap\", new StalledSessionsFilter());\r\n \r\n                 // Add the SSL filter now since sockets are \"borned\" encrypted in the old ssl method\r\n                 SSLContext sslContext = SSLContext.getInstance(algorithm);\r"
        }
    ]
}