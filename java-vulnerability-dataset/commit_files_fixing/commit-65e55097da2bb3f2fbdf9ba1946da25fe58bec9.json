{
    "sha": "65e55097da2bb3f2fbdf9ba1946da25fe58bec98",
    "node_id": "MDY6Q29tbWl0MjM0MTg1MTc6NjVlNTUwOTdkYTJiYjNmMmZiZGY5YmExOTQ2ZGEyNWZlNThiZWM5OA==",
    "commit": {
        "author": {
            "name": "Kihwal Lee",
            "email": "kihwal@apache.org",
            "date": "2018-05-29T19:30:29Z"
        },
        "committer": {
            "name": "Kihwal Lee",
            "email": "kihwal@apache.org",
            "date": "2018-05-29T19:30:29Z"
        },
        "message": "Additional check when unpacking archives. Contributed by Wilfred Spiegelenburg.",
        "tree": {
            "sha": "2c4a0c80d60a53fb5e829310ed86531f90689d10",
            "url": "https://api.github.com/repos/apache/hadoop/git/trees/2c4a0c80d60a53fb5e829310ed86531f90689d10"
        },
        "url": "https://api.github.com/repos/apache/hadoop/git/commits/65e55097da2bb3f2fbdf9ba1946da25fe58bec98",
        "comment_count": 0,
        "verification": {
            "verified": false,
            "reason": "unsigned",
            "signature": null,
            "payload": null,
            "verified_at": null
        }
    },
    "url": "https://api.github.com/repos/apache/hadoop/commits/65e55097da2bb3f2fbdf9ba1946da25fe58bec98",
    "html_url": "https://github.com/apache/hadoop/commit/65e55097da2bb3f2fbdf9ba1946da25fe58bec98",
    "comments_url": "https://api.github.com/repos/apache/hadoop/commits/65e55097da2bb3f2fbdf9ba1946da25fe58bec98/comments",
    "author": {
        "login": "kihwal",
        "id": 340000,
        "node_id": "MDQ6VXNlcjM0MDAwMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/340000?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kihwal",
        "html_url": "https://github.com/kihwal",
        "followers_url": "https://api.github.com/users/kihwal/followers",
        "following_url": "https://api.github.com/users/kihwal/following{/other_user}",
        "gists_url": "https://api.github.com/users/kihwal/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/kihwal/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/kihwal/subscriptions",
        "organizations_url": "https://api.github.com/users/kihwal/orgs",
        "repos_url": "https://api.github.com/users/kihwal/repos",
        "events_url": "https://api.github.com/users/kihwal/events{/privacy}",
        "received_events_url": "https://api.github.com/users/kihwal/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
    },
    "committer": {
        "login": "kihwal",
        "id": 340000,
        "node_id": "MDQ6VXNlcjM0MDAwMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/340000?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kihwal",
        "html_url": "https://github.com/kihwal",
        "followers_url": "https://api.github.com/users/kihwal/followers",
        "following_url": "https://api.github.com/users/kihwal/following{/other_user}",
        "gists_url": "https://api.github.com/users/kihwal/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/kihwal/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/kihwal/subscriptions",
        "organizations_url": "https://api.github.com/users/kihwal/orgs",
        "repos_url": "https://api.github.com/users/kihwal/repos",
        "events_url": "https://api.github.com/users/kihwal/events{/privacy}",
        "received_events_url": "https://api.github.com/users/kihwal/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
    },
    "parents": [
        {
            "sha": "d5708bbcdc86a18cb43f2243629d69dcdae702de",
            "url": "https://api.github.com/repos/apache/hadoop/commits/d5708bbcdc86a18cb43f2243629d69dcdae702de",
            "html_url": "https://github.com/apache/hadoop/commit/d5708bbcdc86a18cb43f2243629d69dcdae702de"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 41,
        "deletions": 0
    },
    "files": [
        {
            "sha": "678e4593df1b1fc15651c22bf4fed0d819daa860",
            "filename": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/RunJar.java",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/apache/hadoop/blob/65e55097da2bb3f2fbdf9ba1946da25fe58bec98/hadoop-common-project%2Fhadoop-common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fhadoop%2Futil%2FRunJar.java",
            "raw_url": "https://github.com/apache/hadoop/raw/65e55097da2bb3f2fbdf9ba1946da25fe58bec98/hadoop-common-project%2Fhadoop-common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fhadoop%2Futil%2FRunJar.java",
            "contents_url": "https://api.github.com/repos/apache/hadoop/contents/hadoop-common-project%2Fhadoop-common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fhadoop%2Futil%2FRunJar.java?ref=65e55097da2bb3f2fbdf9ba1946da25fe58bec98",
            "patch": "@@ -109,6 +109,7 @@ public static void unJar(File jarFile, File toDir, Pattern unpackRegex)\n       throws IOException {\n     try (JarFile jar = new JarFile(jarFile)) {\n       int numOfFailedLastModifiedSet = 0;\n+      String targetDirPath = toDir.getCanonicalPath() + File.separator;\n       Enumeration<JarEntry> entries = jar.entries();\n       while (entries.hasMoreElements()) {\n         final JarEntry entry = entries.nextElement();\n@@ -117,6 +118,10 @@ public static void unJar(File jarFile, File toDir, Pattern unpackRegex)\n           try (InputStream in = jar.getInputStream(entry)) {\n             File file = new File(toDir, entry.getName());\n             ensureDirectory(file.getParentFile());\n+            if (!file.getCanonicalPath().startsWith(targetDirPath)) {\n+              throw new IOException(\"expanding \" + entry.getName()\n+                  + \" would create file outside of \" + toDir);\n+            }\n             try (OutputStream out = new FileOutputStream(file)) {\n               IOUtils.copyBytes(in, out, BUFFER_SIZE);\n             }"
        },
        {
            "sha": "cb2cfa89c1e23568dc9b52f7b765c80a7c536e9e",
            "filename": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/util/TestRunJar.java",
            "status": "modified",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/apache/hadoop/blob/65e55097da2bb3f2fbdf9ba1946da25fe58bec98/hadoop-common-project%2Fhadoop-common%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fhadoop%2Futil%2FTestRunJar.java",
            "raw_url": "https://github.com/apache/hadoop/raw/65e55097da2bb3f2fbdf9ba1946da25fe58bec98/hadoop-common-project%2Fhadoop-common%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fhadoop%2Futil%2FTestRunJar.java",
            "contents_url": "https://api.github.com/repos/apache/hadoop/contents/hadoop-common-project%2Fhadoop-common%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fhadoop%2Futil%2FTestRunJar.java?ref=65e55097da2bb3f2fbdf9ba1946da25fe58bec98",
            "patch": "@@ -20,12 +20,15 @@\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n import static org.mockito.Mockito.spy;\n import static org.mockito.Mockito.when;\n \n import java.io.File;\n import java.io.FileOutputStream;\n import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.jar.JarEntry;\n import java.util.jar.JarOutputStream;\n import java.util.regex.Pattern;\n import java.util.zip.ZipEntry;\n@@ -165,4 +168,37 @@ public void testClientClassLoader() throws Throwable {\n     runJar.run(args);\n     // it should not throw an exception\n   }\n+\n+  @Test\n+  public void testUnJar2() throws IOException {\n+    // make a simple zip\n+    File jarFile = new File(TEST_ROOT_DIR, TEST_JAR_NAME);\n+    JarOutputStream jstream =\n+        new JarOutputStream(new FileOutputStream(jarFile));\n+    JarEntry je = new JarEntry(\"META-INF/MANIFEST.MF\");\n+    byte[] data = \"Manifest-Version: 1.0\\nCreated-By: 1.8.0_1 (Manual)\"\n+        .getBytes(StandardCharsets.UTF_8);\n+    je.setSize(data.length);\n+    jstream.putNextEntry(je);\n+    jstream.write(data);\n+    jstream.closeEntry();\n+    je = new JarEntry(\"../outside.path\");\n+    data = \"any data here\".getBytes(StandardCharsets.UTF_8);\n+    je.setSize(data.length);\n+    jstream.putNextEntry(je);\n+    jstream.write(data);\n+    jstream.closeEntry();\n+    jstream.close();\n+\n+    File unjarDir = getUnjarDir(\"unjar-path\");\n+\n+    // Unjar everything\n+    try {\n+      RunJar.unJar(jarFile, unjarDir);\n+      fail(\"unJar should throw IOException.\");\n+    } catch (IOException e) {\n+      GenericTestUtils.assertExceptionContains(\n+          \"would create file outside of\", e);\n+    }\n+  }\n }\n\\ No newline at end of file"
        }
    ]
}