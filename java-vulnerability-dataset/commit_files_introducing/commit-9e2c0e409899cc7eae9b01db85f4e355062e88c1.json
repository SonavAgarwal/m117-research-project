{
    "sha": "9e2c0e409899cc7eae9b01db85f4e355062e88c1",
    "node_id": "MDY6Q29tbWl0NTEwMzc4NTo5ZTJjMGU0MDk4OTljYzdlYWU5YjAxZGI4NWY0ZTM1NTA2MmU4OGMx",
    "commit": {
        "author": {
            "name": "Stuart Douglas",
            "email": "stuart.w.douglas@gmail.com",
            "date": "2014-07-11T23:42:14Z"
        },
        "committer": {
            "name": "Stuart Douglas",
            "email": "stuart.w.douglas@gmail.com",
            "date": "2014-07-11T23:42:14Z"
        },
        "message": "Ignore HTTP2 upgrade requests when deciding to redirect",
        "tree": {
            "sha": "9cd435ca520870429c504753766eea4a6f099935",
            "url": "https://api.github.com/repos/undertow-io/undertow/git/trees/9cd435ca520870429c504753766eea4a6f099935"
        },
        "url": "https://api.github.com/repos/undertow-io/undertow/git/commits/9e2c0e409899cc7eae9b01db85f4e355062e88c1",
        "comment_count": 0,
        "verification": {
            "verified": false,
            "reason": "unsigned",
            "signature": null,
            "payload": null,
            "verified_at": null
        }
    },
    "url": "https://api.github.com/repos/undertow-io/undertow/commits/9e2c0e409899cc7eae9b01db85f4e355062e88c1",
    "html_url": "https://github.com/undertow-io/undertow/commit/9e2c0e409899cc7eae9b01db85f4e355062e88c1",
    "comments_url": "https://api.github.com/repos/undertow-io/undertow/commits/9e2c0e409899cc7eae9b01db85f4e355062e88c1/comments",
    "author": {
        "login": "stuartwdouglas",
        "id": 328571,
        "node_id": "MDQ6VXNlcjMyODU3MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/328571?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stuartwdouglas",
        "html_url": "https://github.com/stuartwdouglas",
        "followers_url": "https://api.github.com/users/stuartwdouglas/followers",
        "following_url": "https://api.github.com/users/stuartwdouglas/following{/other_user}",
        "gists_url": "https://api.github.com/users/stuartwdouglas/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/stuartwdouglas/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/stuartwdouglas/subscriptions",
        "organizations_url": "https://api.github.com/users/stuartwdouglas/orgs",
        "repos_url": "https://api.github.com/users/stuartwdouglas/repos",
        "events_url": "https://api.github.com/users/stuartwdouglas/events{/privacy}",
        "received_events_url": "https://api.github.com/users/stuartwdouglas/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
    },
    "committer": {
        "login": "stuartwdouglas",
        "id": 328571,
        "node_id": "MDQ6VXNlcjMyODU3MQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/328571?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stuartwdouglas",
        "html_url": "https://github.com/stuartwdouglas",
        "followers_url": "https://api.github.com/users/stuartwdouglas/followers",
        "following_url": "https://api.github.com/users/stuartwdouglas/following{/other_user}",
        "gists_url": "https://api.github.com/users/stuartwdouglas/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/stuartwdouglas/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/stuartwdouglas/subscriptions",
        "organizations_url": "https://api.github.com/users/stuartwdouglas/orgs",
        "repos_url": "https://api.github.com/users/stuartwdouglas/repos",
        "events_url": "https://api.github.com/users/stuartwdouglas/events{/privacy}",
        "received_events_url": "https://api.github.com/users/stuartwdouglas/received_events",
        "type": "User",
        "user_view_type": "public",
        "site_admin": false
    },
    "parents": [
        {
            "sha": "02d385262f8117aa1258bba999c8ac36b455845c",
            "url": "https://api.github.com/repos/undertow-io/undertow/commits/02d385262f8117aa1258bba999c8ac36b455845c",
            "html_url": "https://github.com/undertow-io/undertow/commit/02d385262f8117aa1258bba999c8ac36b455845c"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 7,
        "deletions": 1
    },
    "files": [
        {
            "sha": "383f3a5aad6c3cdd29cc10e2435a0e33ba2258e0",
            "filename": "servlet/src/main/java/io/undertow/servlet/handlers/ServletInitialHandler.java",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/undertow-io/undertow/blob/9e2c0e409899cc7eae9b01db85f4e355062e88c1/servlet%2Fsrc%2Fmain%2Fjava%2Fio%2Fundertow%2Fservlet%2Fhandlers%2FServletInitialHandler.java",
            "raw_url": "https://github.com/undertow-io/undertow/raw/9e2c0e409899cc7eae9b01db85f4e355062e88c1/servlet%2Fsrc%2Fmain%2Fjava%2Fio%2Fundertow%2Fservlet%2Fhandlers%2FServletInitialHandler.java",
            "contents_url": "https://api.github.com/repos/undertow-io/undertow/contents/servlet%2Fsrc%2Fmain%2Fjava%2Fio%2Fundertow%2Fservlet%2Fhandlers%2FServletInitialHandler.java?ref=9e2c0e409899cc7eae9b01db85f4e355062e88c1",
            "patch": "@@ -34,6 +34,7 @@\n import io.undertow.servlet.spec.HttpServletResponseImpl;\n import io.undertow.servlet.spec.RequestDispatcherImpl;\n import io.undertow.servlet.spec.ServletContextImpl;\n+import io.undertow.util.HeaderValues;\n import io.undertow.util.Headers;\n import io.undertow.util.HttpString;\n import io.undertow.util.Protocols;\n@@ -75,6 +76,8 @@\n  */\n public class ServletInitialHandler implements HttpHandler, ServletDispatcher {\n \n+    private static final String HTTP2_UPGRADE_PREFIX = \"h2\";\n+\n     private static final RuntimePermission PERMISSION = new RuntimePermission(\"io.undertow.servlet.CREATE_INITIAL_HANDLER\");\n \n     private final HttpHandler next;\n@@ -112,7 +115,10 @@ public void handleRequest(final HttpServerExchange exchange) throws Exception {\n         //https://issues.jboss.org/browse/WFLY-3439\n         //if the request is an upgrade request then we don't want to redirect\n         //as there is a good chance the web socket client won't understand the redirect\n-        boolean isUpgradeRequest = exchange.getRequestHeaders().contains(Headers.UPGRADE);\n+        //we make an exception for HTTP2 upgrade requests, as this would have already be handled at\n+        //the connector level if it was going to be handled.\n+        String upgradeString = exchange.getRequestHeaders().getFirst(Headers.UPGRADE);\n+        boolean isUpgradeRequest = upgradeString != null && !upgradeString.startsWith(HTTP2_UPGRADE_PREFIX);\n         if (info.getType() == ServletPathMatch.Type.REDIRECT && !isUpgradeRequest) {\n             //UNDERTOW-89\n             //we redirect on GET requests to the root context to add an / to the end"
        }
    ]
}